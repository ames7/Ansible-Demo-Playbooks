---
  - name: Create Azure Virtual Machine
    hosts: localhost
    connection: local
    gather_facts: no
    vars:
       az_rgname: ''
       az_vmname: ''
       az_vmusername: ''
       customer: ''
       sshpubkey: !vault |
           $ANSIBLE_VAULT;1.1;AES256
           62336363383861306463336637316331386134373230343663373261653962333030333935636661
           3234316637383739396534343434396539323434663834330a616165363937653533663163386264
           34643137613430326564393637643730376261656165646566633733626163373133656234376361
           6634376234663263660a373732616534363734653962333431366663376663343038373466313866
           38386638303766383933663832353962623230336566626232326539643963373061396335383834
           35383934323565613031366637353838666133353363326435313166343464373436323362386136
           33353866326534623864326438373939366463356565383836663933383937356265636237656537
           33636664643966653739623438393566366138326236636165363836336366326131303063633031
           38636238356232373739376435383338323931323933333136373737643235316334393564663962
           64383130653135396430636463323564393764613563653539366365383438306434353836646637
           37396139663032356263366133343731393837656237393834653935313066613164663234373739
           65396235323738663336343762623437636566633764353162396362633039633032636234316561
           31386632643962323665646366636564313564616231383635393962623833303964616331393464
           38613630616232323238353937643334623038353536353336636137366231366161666236376464
           32636661666433663665356463646239343265343836393663343964626534653130396563356134
           35303262623139653861623430356630313237646530313139623963396364326332306339653632
           30373764383437353066306138346239376530346431656332313630656436633261303262643632
           33623031306439646561396162353439356665653530376132356264616633633765386639343063
           33653164366432356164623063376530393537393464653233323830303364363335326564653837
           38303832346330303233363664623337303561663563323431663534366339353062393361333937
           37326632626630643636626437306539333563396434636432623432643936343231643334326433
           30636336323435616438623630363066373565306664326231363366616336396230396436356639
           6335643536353931336239646536356138303634333661666538376161623437666
       AZURE_CLIENT_ID: ''
       AZURE_SECRET: ''
       AZURE_SUBSCRIPTION_ID: ''
       AZURE_TENANT: ''
    tasks:
       - include: createvmsecgroup.yml
#       - include: createpublicip.yml
       - name: Creating Vnic for {{az_vmname}}
         azure_rm_networkinterface:
           resource_group: "{{az_rgname}}"
           name: "{{az_vmname}}{{'_nic'}}"
           virtual_network: "{{az_rgname}}"
           subnet: "{{az_rgname}}{{'_net1'}}"
           ip_configurations:
             - name: "{{az_vmname}}{{'_int'}}"
               public_ip_address_name: "{{az_vmname}}{{'_PublicIP'}}"
               primary: yes
           security_group: "{{az_vmname}}{{'_SecGrp'}}"
           tags:
             created: ansbile
             delete: never
             demo: "{{customer}}"
             use: Demo
       - name: Creating Virtual Machine {{az_vmname}} in {{az_rgname}}_net1
         azure_rm_virtualmachine:
           resource_group: "{{az_rgname}}"
           name: "{{az_vmname}}"
           vm_size: Basic_A1
           admin_username: "{{az_vmusername}}"
           ssh_password_enabled: false
           ssh_public_keys:
             - path: "{{'/home/'}}{{az_vmusername}}{{'/.ssh/authorized_keys'}}"
               key_data: "{{sshpubkey}}"
           network_interfaces: "{{az_vmname}}{{'_nic'}}"
           image:
             offer: rhel-byos
             publisher: RedHat
             sku: 'rhel-lvm77'
             version: latest
           plan:
             name: rhel-lvm77
             product: rhel-byos
             publisher: redhat
       - include: getpubip.yml
         vars:
           publicip: "{{az_vmname}}{{'_PublicIP'}}"
