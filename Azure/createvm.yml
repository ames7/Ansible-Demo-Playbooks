---
  - name: Create Azure Virtual Machine
    hosts: localhost
    connection: local
    gather_facts: no
    vars:
       az_rgname: ''
       az_vmname: ''
       az_vmusername: ''
       customer: ''
       sshpubkey: ''
       AZURE_CLIENT_ID: ''
       AZURE_SECRET: ''
       AZURE_SUBSCRIPTION_ID: ''
       AZURE_TENANT: ''
    tasks:
       - include: createvmsecgroup.yml
       - name: Creating Vnic for {{az_vmname}}
         azure_rm_networkinterface:
           resource_group: "{{az_rgname}}"
           name: "{{az_vmname}}{{'_nic'}}"
           virtual_network: "{{az_rgname}}"
           subnet: "{{az_rgname}}{{'_net1'}}"
           ip_configurations:
             - name: "{{az_vmname}}{{'_int'}}"
               public_ip_address_name: "{{az_vmname}}{{'_PublicIP'}}"
               primary: yes
           security_group: "{{az_vmname}}{{'_SecGrp'}}"
           tags:
             created: ansbile
             delete: never
             demo: "{{customer}}"
             use: Demo
       - name: Creating Virtual Machine {{az_vmname}} in {{az_rgname}}_net1
         azure_rm_virtualmachine:
           resource_group: "{{az_rgname}}"
           name: "{{az_vmname}}"
           vm_size: Basic_A1
           admin_username: "{{az_vmusername}}"
           ssh_password_enabled: false
           ssh_public_keys:
             - path: "{{'/home/'}}{{az_vmusername}}{{'/.ssh/authorized_keys'}}"
               key_data: "{{sshpubkey}}"
           network_interfaces: "{{az_vmname}}{{'_nic'}}"
           image:
             offer: rhel-byos
             publisher: RedHat
             sku: 'rhel-lvm77'
             version: latest
           plan:
             name: rhel-lvm77
             product: rhel-byos
             publisher: redhat
       - include: getpubip.yml
         vars:
           publicip: "{{az_vmname}}{{'_PublicIP'}}"
