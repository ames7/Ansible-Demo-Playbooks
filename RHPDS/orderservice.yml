---
- name: Spinup RHPDS AWS Blank Enviornment
  hosts: all
  gather_facts: False
  tasks:
    - name: Request Service Template {{ catalogitem }} from RHPDS
      uri:
        url: "{{ rhpdsurl }}/api/v3.0.0/service_catalogs/{{ catalogitem }}/service_templates"
        user: "{{ rhpdsuser }}"
        password: "{{ rhpdspass }}"
        method: POST
        body: "{{ rhpdsawsorder }}"
        body_format: json
      register: requestinfo
    #- name:
    #  debug:
    #    msg: "{{requestinfo.json.results[0].id}}"
    - name: Set fact
      set_fact:
        serviceid: "{{ requestinfo.json.results[0].id }}"
    - name: Show new fact
      debug:
        msg: "{{ serviceid }}"
        verbosity: 2

    - include: getservicecreds.yml
    - name: Add RHPDS AWS Creds to Controller
      awx.awx.tower_credential:
        name: "AWS_RHPDS_API"
        organization: "{{ org }}"
        state: present
        credential_type: Amazon Web Services
        validate_certs: no
        inputs:
          username: "{{aws_access_key}}"
          password: "{{aws_access_secret}}"
