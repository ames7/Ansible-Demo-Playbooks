---
  - name: Get instances info
    hosts: localhost
    connection: local
    gather_facts: no
    vars:
       aws_access_key: ''
       aws_secret_key: ''
       count: ''
       key_name: ''
       instance_type: ''
       image: ''
       wait: ''
       wait_timeout: ''
       assign_public_ip: ''
       subnet_name: ''
       region: ''

    tasks:


    - name: If vpc_subnet_id doesnt exist lookup by {{subnet_name}}
      ec2_vpc_subnet_info:
        region: "{{region}}"
        filters:
           "tag:Name": ansibleservers_Subnet
      register: subnet_info

    - name: Setting vpc_subnet_id based on Lookup of {{subnet_name}}
      set_fact:
        vpc_subnet_id: "{{subnet_info.subnets[0].id}}"


    - name: Show Subnet_id
      debug:
        msg: "{{vpc_subnet_id}}"

    - name: Creating {{count}} AWS VMs in {{region}}
      ec2:
       key_name: "{{key_name}}"
       instance_type: "{{instance_type}}"
       image:  "{{image}}"
       wait: "{{wait}}"
       wait_timeout: "{{wait_timeout}}"
       group: "{{group}}"
       count: "{{count}}"
       vpc_subnet_id:  "{{vpc_subnet_id}}"
       assign_public_ip: "{{assign_public_ip}}"
